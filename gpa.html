<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEB GPA Calculator - KingamerNep</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- CSS Styling --- */
        :root {
            --background-color: #f4f7f9;
            --card-background: #ffffff;
            --text-color: #333;
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --danger-color: #dc3545; /* Red */
            --success-color: #28a745; /* Green */
            --border-color: #e0e0e0;
            --grade-A: #28a745; 
            --grade-B: #007bff; 
            --grade-C: #ff8c00; 
            --grade-D: #dc3545; 
        }

        body.dark-mode {
            --background-color: #1a1a2e;
            --card-background: #2c2c43;
            --text-color: #e6e6e6;
            --primary-color: #8c9eff; /* Lighter Blue */
            --secondary-color: #a0a0a0;
            --danger-color: #ff6b6b;
            --success-color: #4cd964;
            --border-color: #444466;
        }

        /* --- Base Styling --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; min-height: 100vh; }
        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 0 15px; 
            display: grid; 
            gap: 20px; 
            grid-template-columns: 1fr;
        }

        /* --- Components --- */
        header { background-color: var(--card-background); padding: 20px 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .header-actions { display: flex; gap: 10px; }
        .card { background-color: var(--card-background); border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }

        button, select, input { 
            padding: 10px 15px; 
            border-radius: 5px; 
            font-size: 1rem; 
            border: 1px solid var(--border-color); 
            color: var(--text-color); 
            background-color: var(--card-background); 
            transition: border-color 0.3s, background-color 0.3s;
        }
        button { cursor: pointer; font-weight: 600; border: none; }
        .primary-btn { background-color: var(--primary-color); color: white; }
        .secondary-btn { background-color: var(--secondary-color); color: white; }
        .danger-btn { background-color: var(--danger-color); color: white; }
        .share-btn { background-color: var(--success-color); color: white; }

        /* --- Input Details --- */
        #configPanel { display: flex; flex-direction: column; gap: 15px; }
        #configPanel > div { display: flex; flex-direction: column; gap: 5px; }
        .action-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .subjects-panel h2 { font-size: 1.3rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 15px; }
        .subject-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            align-items: center; 
            padding: 15px 0; 
            border-bottom: 1px dashed var(--border-color); 
        }
        
        .marks-input-group {
            display: flex;
            gap: 10px;
            flex-grow: 2;
        }
        
        .marks-input-group input { flex: 1; min-width: 70px; } 

        .subject-row input[type="text"] { flex: 2; min-width: 150px; }
        .subject-row select { min-width: 70px; }
        .fail-info { font-size: 0.8rem; color: var(--secondary-color); min-width: 50px; text-align: center; white-space: nowrap; }
        .remove-btn { background: none; color: var(--danger-color); padding: 5px; border: 1px solid var(--danger-color); }

        /* --- Results Panel Hiding Logic (IMPORTANT FOR MOBILE) --- */
        #resultsPanel { 
            transition: opacity 0.3s, max-height 0.5s ease-out;
            overflow: hidden;
            max-height: 2000px; 
        }
        
        .hidden {
            opacity: 0;
            max-height: 0;
            padding: 0 20px; 
            margin-top: 0;
            margin-bottom: 0;
        }

        /* --- Mobile View Toggling (Crucial for the app-like feel) --- */
        @media (max-width: 767px) {
            .container { display: block; }

            /* Only show Input elements in input-view */
            .input-view #resultsPanel { display: none !important; }
            
            /* Only show Results elements in results-view */
            .results-view #subjectsPanel,
            .results-view #configPanel,
            .results-view #inputBox .action-group { display: none !important; }
            .results-view #resultsPanel { display: block !important; }
            
            /* Show toggle buttons on mobile only */
            #backToInputBtn { display: inline-block !important; }
            .input-view #viewResultsBtn { display: inline-block !important; }
            .results-view #viewResultsBtn { display: none !important; } 
            
            /* Subject row adjustments for very small screens */
            .subject-row { 
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        /* --- Desktop View (Two Columns) --- */
        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 2fr;
                grid-template-areas:
                    "config results"
                    "subjects results";
            }
            #configPanel { grid-area: config; }
            #subjectsPanel { grid-area: subjects; }
            #resultsPanel { grid-area: results; }
            
            /* Hide mobile-only buttons on desktop */
            #backToInputBtn { display: none !important; }
            #viewResultsBtn { display: none !important; }
            
            /* Refined row layout for desktop */
            .subject-row { 
                flex-wrap: nowrap;
                justify-content: space-between;
            }
            .marks-input-group { flex-grow: 0; max-width: 250px; }
            .marks-input-group input { min-width: 0; }
        }

        /* --- Results Details --- */
        .overall-results { display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px; text-align: center; }
        .overall-gpa-meter { 
            width: 120px; height: 120px; border-radius: 50%; 
            border: 5px solid var(--border-color); 
            display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .gpa-display span { font-size: 2.5rem; font-weight: 700; display: block; line-height: 1; transition: color 0.3s; }
        #resultsTable { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        #resultsTable th, #resultsTable td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .progress-bar-container { background-color: var(--border-color); border-radius: 5px; overflow: hidden; height: 20px; position: relative; width: 100%; }
        .progress-bar { height: 100%; width: 0; transition: width 1s ease-out, background-color 0.3s; display: flex; align-items: center; padding-left: 5px; color: white; font-weight: 600; font-size: 0.8rem; white-space: nowrap; }
        .grade-A-color { background-color: var(--grade-A); }
        .grade-B-color { background-color: var(--grade-B); }
        .grade-C-color { background-color: var(--grade-C); }
        .grade-D-color { background-color: var(--grade-D); }
        .grade-text-A { color: var(--grade-A); font-weight: 700; }
        .grade-text-B { color: var(--grade-B); font-weight: 700; }
        .grade-text-C { color: var(--grade-C); font-weight: 700; }
        .grade-text-D { color: var(--grade-D); font-weight: 700; }
        .export-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .export-actions button { flex-grow: 1; min-width: 120px; }
        footer { text-align: center; padding: 15px; margin-top: 30px; border-top: 1px solid var(--border-color); color: var(--secondary-color); }

        /* --- About Modal Styles --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            backdrop-filter: blur(2px);
            transition: opacity 0.3s;
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 10% auto; 
            padding: 25px;
            border-radius: 12px;
            width: 85%; 
            max-width: 450px;
            position: relative;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }
        
        /* --- CUSTOM DIALOG STYLES (New "Good Vibe Box") --- */
        #customDialogModal {
            z-index: 1001; /* Higher than 'About' modal */
        }
        
        #customDialogContent {
            margin: 25% auto; /* Move higher for better visibility */
        }

        #dialogMessage {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.5;
            text-align: center;
        }
        
        #dialogActions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        #dialogActions button {
            flex-grow: 1;
            min-width: 100px;
            padding: 10px 15px;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* (Rest of Modal Styles remain the same) */

        .creator-info { text-align: center; margin: 20px 0 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .creator-photo-container { width: 80px; height: 80px; margin: 0 auto 10px auto; border-radius: 50%; background-color: var(--primary-color); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .creator-icon { font-size: 40px; color: white; }
        .creator-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; color: var(--primary-color); }
        .app-description { font-style: italic; color: var(--secondary-color); margin-bottom: 0; font-size: 0.9rem; }
        .other-details { margin-top: 20px; padding-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body class="input-view"> 
    <header>
        <h1>🇳🇵 NEB GPA Calculator</h1>
        <div class="header-actions">
            <button id="aboutAppBtn" aria-label="About the App" class="secondary-btn"><i class="fas fa-info-circle"></i> About</button>
            <button id="darkModeToggle" aria-label="Toggle dark/light mode" class="secondary-btn">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <main class="container">
        <div id="inputBox">
            <section id="configPanel" class="card">
                <div>
                    <label for="subjectStream">Select Stream Preset:</label>
                    <select id="subjectStream">
                        <option value="custom">Custom Subject Setup</option>
                        <option value="science">Science (6 Subjects)</option>
                        <option value="management">Management (6 Subjects)</option>
                        <option value="humanities">Humanities (6 Subjects)</option>
                    </select>
                </div>

                <div>
                    <label for="subjectCount">No. of Subjects:</label>
                    <select id="subjectCount">
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6" selected>6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>

                <div class="action-group">
                    <button id="addSubjectBtn" class="primary-btn" style="flex-grow: 1;"><i class="fas fa-plus-circle"></i> Add Subject</button>
                    <button id="calculateBtn" class="primary-btn" style="flex-grow: 1;"><i class="fas fa-calculator"></i> Calculate GPA</button>
                    <button id="viewResultsBtn" class="secondary-btn" style="display:none; flex-grow: 1;"><i class="fas fa-chart-bar"></i> View Results</button>
                </div>
            </section>

            <section id="subjectsPanel" class="subjects-panel card">
                <h2>Subject Details</h2>
                <div id="subjectsContainer">
                    </div>
            </section>
        </div>

        <section id="resultsPanel" class="results-panel card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>GPA Results</h2>
                <button id="backToInputBtn" class="secondary-btn" style="display:none;"><i class="fas fa-arrow-left"></i> Back to Input</button>
            </div>

            <div id="previousResultBanner" style="display:none; padding:10px; background-color: var(--border-color); border-radius: 5px; margin-bottom: 15px;">
                <p>Last Calculated GPA: <strong id="lastGPA">--</strong> on <span id="lastCalcDate">--</span></p>
                <button id="showLastResultBtn" class="secondary-btn" style="padding: 5px 10px; font-size: 0.9rem;">Show Last Result</button>
            </div>

            <div class="overall-results">
                <div class="overall-gpa-meter">
                    <div class="gpa-display">
                        <span id="overallGPA">--</span>
                        <small>Overall GPA</small>
                    </div>
                </div>
                <div class="overall-percentage" style="text-align: left;">
                    <p>Overall Percentage: <strong id="overallPercentage">--</strong></p>
                    <p>Total Marks: <strong id="totalMarks">0 / 0</strong></p>
                </div>
            </div>

            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th style="min-width: 100px;">%</th>
                        <th>Grade</th>
                        <th>GPA</th>
                    </tr>
                </thead>
                <tbody id="perSubjectResults">
                    </tbody>
            </table>

            <div class="export-actions">
                <button id="shareBtn" class="share-btn"><i class="fas fa-share-alt"></i> Share Results</button>
                <button id="exportPdfBtn" class="secondary-btn"><i class="fas fa-file-pdf"></i> Export PDF</button>
                <button id="exportCsvBtn" class="secondary-btn"><i class="fas fa-file-csv"></i> Export CSV</button>
                <button id="resetBtn" class="danger-btn"><i class="fas fa-undo"></i> Reset All</button>
            </div>
        </section>
    </main>

    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>About NEB GPA Calculator</h2>
            
            <div class="creator-info">
                <div class="creator-photo-container">
                    <i class="fas fa-crown creator-icon"></i> 
                </div>
                <h3 class="creator-name">KingamerNep (David Shrestha)</h3>
                <p class="app-description">A fast, mobile-friendly GPA calculator for students under the Nepali National Examinations Board (NEB) system.</p>
            </div>
            
            <div class="other-details">
                <p><strong>Version:</strong> 1.0.3</p>
                <p><strong>Features:</strong> **Local Storage** (saves inputs & results), **Dark Mode**, **PDF/CSV Export**, and **Mobile App** compatibility via Webintoapp.</p>
                <p><strong>Source:</strong> Made with ❤️ by KingamerNep</p>
            </div>
        </div>
    </div>
    
    <div id="customDialogModal" class="modal">
        <div class="modal-content" id="customDialogContent">
            <div id="dialogMessage"></div>
            <div id="dialogActions">
                </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 KingamerNep David | Made with ❤️ by KingamerNep</p>
    </footer>

    <script>
        // --- JavaScript Logic ---
        
        // --- CONSTANTS & DOM Elements (Same as before) ---
        const GRADING_SCALE = [
            { min: 90, max: 100, grade: 'A+', gpa: 4.0, colorClass: 'grade-A' },
            { min: 80, max: 89, grade: 'A', gpa: 3.6, colorClass: 'grade-A' },
            { min: 70, max: 79, grade: 'B+', gpa: 3.2, colorClass: 'grade-B' },
            { min: 60, max: 69, grade: 'B', gpa: 2.8, colorClass: 'grade-B' },
            { min: 50, max: 59, grade: 'C+', gpa: 2.4, colorClass: 'grade-C' },
            { min: 40, max: 49, grade: 'C', gpa: 2.0, colorClass: 'grade-C' },
            { min: 0, max: 39, grade: 'D/F', gpa: 0.0, colorClass: 'grade-D' }
        ];

        const PASS_MARKS = {
            100: 35, 75: 26, 50: 17,
            theory_75: 26, 
            practical_25: 9  
        };
        
        const SUBJECT_PRESETS = {
            science: [
                { name: 'Nepali', full: 100 }, { name: 'English', full: 100 }, { name: 'Physics', full: 100 },
                { name: 'Chemistry', full: 100 }, { name: 'Mathematics', full: 100 }, { name: 'Biology / Comp Science', full: 100 },
            ],
            management: [
                { name: 'Nepali', full: 100 }, { name: 'English', full: 100 }, { name: 'Basic Math/Economics', full: 100 },
                { name: 'Accountancy', full: 100 }, { name: 'Business Studies', full: 100 }, { name: 'Marketing / Finance', full: 100 }
            ],
            humanities: [
                { name: 'Nepali', full: 100 }, { name: 'English', full: 100 }, { name: 'Social Studies', full: 100 },
                { name: 'Major I (e.g. History)', full: 100 }, { name: 'Major II (e.g. Sociology)', full: 100 }, { name: 'Minor (e.g. Psychology)', full: 100 }
            ],
            custom: [] 
        };

        let subjectCounter = 0; 
        const subjectsContainer = document.getElementById('subjectsContainer');
        const subjectCountDropdown = document.getElementById('subjectCount');
        const subjectStreamDropdown = document.getElementById('subjectStream');
        const resultsTableBody = document.getElementById('perSubjectResults');
        const overallGPADisplay = document.getElementById('overallGPA');
        const overallPercentageDisplay = document.getElementById('overallPercentage');
        const totalMarksDisplay = document.getElementById('totalMarks');
        const resultsPanel = document.getElementById('resultsPanel'); 
        const viewResultsBtn = document.getElementById('viewResultsBtn');
        const previousResultBanner = document.getElementById('previousResultBanner');
        const lastGPADisplay = document.getElementById('lastGPA');
        const lastCalcDateDisplay = document.getElementById('lastCalcDate');
        const body = document.body;
        
        const aboutModal = document.getElementById('aboutModal');
        const aboutAppBtn = document.getElementById('aboutAppBtn');
        const closeBtn = document.querySelector('.close-btn');
        
        // Custom Dialog Elements
        const customDialogModal = document.getElementById('customDialogModal');
        const dialogMessage = document.getElementById('dialogMessage');
        const dialogActions = document.getElementById('dialogActions');
        

        // --- NEW DIALOG FUNCTIONS ---
        
        /**
         * Shows a custom alert box, replacing the native alert().
         * @param {string} message The message to display.
         */
        function showCustomAlert(message) {
            return new Promise(resolve => {
                dialogMessage.innerHTML = message;
                dialogActions.innerHTML = ''; 
                
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.classList.add('primary-btn');
                okButton.addEventListener('click', () => {
                    customDialogModal.style.display = 'none';
                    resolve(true); 
                });
                
                dialogActions.appendChild(okButton);
                customDialogModal.style.display = 'block';
            });
        }

        /**
         * Shows a custom confirm box, replacing the native confirm().
         * @param {string} message The confirmation message.
         * @returns {Promise<boolean>} Resolves with true for OK, false for Cancel.
         */
        function showCustomConfirm(message) {
            return new Promise(resolve => {
                dialogMessage.innerHTML = message;
                dialogActions.innerHTML = ''; 

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'CANCEL';
                cancelButton.classList.add('secondary-btn');
                cancelButton.addEventListener('click', () => {
                    customDialogModal.style.display = 'none';
                    resolve(false); 
                });
                
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.classList.add('primary-btn');
                okButton.addEventListener('click', () => {
                    customDialogModal.style.display = 'none';
                    resolve(true); 
                });
                
                dialogActions.appendChild(cancelButton);
                dialogActions.appendChild(okButton);
                customDialogModal.style.display = 'block';
            });
        }


        // --- CORE FUNCTION: View Management (Same as before) ---
        function toggleView(view) {
            if (window.innerWidth < 768) {
                if (view === 'results') {
                    resultsPanel.classList.remove('hidden');
                    body.classList.remove('input-view');
                    body.classList.add('results-view');
                } else {
                    body.classList.remove('results-view');
                    body.classList.add('input-view');
                    resultsPanel.classList.add('hidden');
                }
            }
        }

        // --- 1. Subject Management Functions (Modified to use custom dialogs) ---

        function getFullMarksDropdown(selected = 100) {
            return `
                <select class="full-marks">
                    <option value="100" ${selected === 100 ? 'selected' : ''}>100</option>
                    <option value="75" ${selected === 75 ? 'selected' : ''}>75</option>
                    <option value="50" ${selected === 50 ? 'selected' : ''}>50</option>
                </select>
            `;
        }
        
        function getMarksInputFields(fullMarks, obtained = '', theory = '', practical = '') {
            if (fullMarks === 100) {
                return `
                    <div class="marks-input-group" data-split="true">
                        <input type="number" class="marks-theory" placeholder="Theory (75)" min="0" max="75" value="${theory}">
                        <input type="number" class="marks-practical" placeholder="Practical (25)" min="0" max="25" value="${practical}">
                    </div>
                `;
            } else {
                return `
                    <div class="marks-input-group" data-split="false">
                        <input type="number" class="marks-obtained" placeholder="Obtained (Max ${fullMarks})" min="0" max="${fullMarks}" value="${obtained}">
                    </div>
                `;
            }
        }

        function updateRowValidationAndSave(row) {
            const fullMarksSelect = row.querySelector('.full-marks');
            const fullMarks = parseInt(fullMarksSelect.value);
            const inputGroup = row.querySelector('.marks-input-group');

            // 1. Regenerate input fields if fullMarks changes
            if (inputGroup.dataset.split === 'true' && fullMarks !== 100 || 
                inputGroup.dataset.split === 'false' && fullMarks === 100) {
                
                let currentObtained = '';
                let currentTheory = '';
                let currentPractical = '';
                
                if(inputGroup.dataset.split === 'true') {
                    currentTheory = row.querySelector('.marks-theory').value;
                    currentPractical = row.querySelector('.marks-practical').value;
                    currentObtained = (parseFloat(currentTheory) || 0) + (parseFloat(currentPractical) || 0);
                } else {
                    currentObtained = row.querySelector('.marks-obtained').value;
                }
                
                const parent = inputGroup.parentElement;
                
                const newHtml = getMarksInputFields(fullMarks, currentObtained, currentTheory, currentPractical);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newHtml;
                parent.replaceChild(tempDiv.firstChild, inputGroup);
                
                const newRow = document.querySelector(`.subject-row[data-id="${row.dataset.id}"]`);
                setupMarkInputListeners(newRow);
                updateRowValidationAndSave(newRow); 
                return; 
            }
            
            // 2. Run Mark Validation and Display Pass Mark
            const failInfoElement = row.querySelector('.fail-info');

            if (fullMarks === 100) {
                const theoryInput = row.querySelector('.marks-theory');
                const practicalInput = row.querySelector('.marks-practical');
                
                if (parseFloat(theoryInput.value) > 75) theoryInput.value = 75;
                if (parseFloat(theoryInput.value) < 0 || isNaN(parseFloat(theoryInput.value))) theoryInput.value = 0;
                
                if (parseFloat(practicalInput.value) > 25) practicalInput.value = 25;
                if (parseFloat(practicalInput.value) < 0 || isNaN(parseFloat(practicalInput.value))) practicalInput.value = 0;

                failInfoElement.textContent = `(T: ${PASS_MARKS.theory_75} / P: ${PASS_MARKS.practical_25})`;

            } else {
                const obtainedInput = row.querySelector('.marks-obtained');
                const obtained = parseFloat(obtainedInput.value);
                const failMark = PASS_MARKS[fullMarks];
                
                if (obtained > fullMarks) obtainedInput.value = fullMarks;
                if (obtained < 0 || isNaN(obtained)) obtainedInput.value = 0;

                failInfoElement.textContent = `(Fail: ${failMark})`;
                obtainedInput.setAttribute('max', fullMarks);
            }
            
            saveSubjectsToLocalStorage();
        }

        function setupMarkInputListeners(row) {
            const fullMarks = parseInt(row.querySelector('.full-marks').value);

            if (fullMarks === 100) {
                row.querySelector('.marks-theory').addEventListener('input', () => updateRowValidationAndSave(row));
                row.querySelector('.marks-practical').addEventListener('input', () => updateRowValidationAndSave(row));
            } else {
                const obtainedInput = row.querySelector('.marks-obtained');
                if (obtainedInput) {
                    obtainedInput.addEventListener('input', () => updateRowValidationAndSave(row));
                }
            }
        }

        function setupRowListeners(row, id) {
            row.querySelector('.full-marks').addEventListener('change', () => updateRowValidationAndSave(row));
            setupMarkInputListeners(row);
            row.querySelector('.remove-btn').addEventListener('click', () => removeSubjectRow(id));
            row.querySelector('.subject-name').addEventListener('input', () => saveSubjectsToLocalStorage());
        }

        function addSubjectRow(initialName = `Subject ${subjectCounter + 1}`, initialObtained = '', initialTheory = '', initialPractical = '', initialFull = 100) {
            subjectCounter++;
            const rowId = subjectCounter;

            const row = document.createElement('div');
            row.classList.add('subject-row');
            row.dataset.id = rowId;
            
            row.innerHTML = `
                <input type="text" class="subject-name" placeholder="Subject Name" value="${initialName}">
                ${getFullMarksDropdown(initialFull)}
                ${getMarksInputFields(initialFull, initialObtained, initialTheory, initialPractical)}
                <span class="fail-info"></span>
                <button class="remove-btn" title="Remove Subject"><i class="fas fa-trash-alt"></i></button>
            `;
            subjectsContainer.appendChild(row);
            
            setupRowListeners(row, rowId);
            updateRowValidationAndSave(row); 
        }

        function removeSubjectRow(id) {
            const rowToRemove = document.querySelector(`.subject-row[data-id="${id}"]`);
            if (rowToRemove) {
                rowToRemove.remove();
                saveSubjectsToLocalStorage(); 
                
                if (subjectStreamDropdown.value === 'custom') {
                    subjectCountDropdown.value = subjectsContainer.children.length;
                }
            }
        }
        
        // Handles Preset Loading (Uses custom confirm)
        async function handleStreamChange() {
            const selectedStream = subjectStreamDropdown.value;
            const preset = SUBJECT_PRESETS[selectedStream];

            if (selectedStream === 'custom') {
                subjectCountDropdown.value = subjectsContainer.children.length; 
                generateInitialSubjects(false, false); 
            } else {
                const continueSwitch = await showCustomConfirm(`Switching to the '${selectedStream}' preset will clear all current inputs and set the count to ${preset.length}. Continue?`);

                if (!continueSwitch) {
                    const savedStream = localStorage.getItem('nebGpaStream') || 'custom';
                    subjectStreamDropdown.value = savedStream; 
                    return;
                }
                
                subjectCountDropdown.value = preset.length;
                subjectsContainer.innerHTML = '';
                subjectCounter = 0; 

                preset.forEach(sub => {
                    addSubjectRow(sub.name, '', '', '', sub.full);
                });
                
                saveSubjectsToLocalStorage();
            }
        }

        async function generateInitialSubjects(loadDataFromStorage = false, checkSubjectCountChange = true) {
             const currentChildrenCount = subjectsContainer.children.length;
             const targetCount = parseInt(subjectCountDropdown.value);
             const savedSubjects = loadDataFromStorage ? JSON.parse(localStorage.getItem('nebGpaSubjects') || '[]') : [];

             if (checkSubjectCountChange && currentChildrenCount > 0 && targetCount !== currentChildrenCount) {
                 const continueChange = await showCustomConfirm(`Changing the subject count to ${targetCount} will clear all current inputs. Continue?`);
                 
                 if (!continueChange) {
                    subjectCountDropdown.value = currentChildrenCount; 
                    return;
                }
            }

            subjectsContainer.innerHTML = '';
            subjectCounter = 0; 
            
            for (let i = 0; i < targetCount; i++) {
                const sub = savedSubjects[i];
                if (sub) {
                    addSubjectRow(
                        sub.name, 
                        sub.obtained, 
                        sub.theory, 
                        sub.practical, 
                        parseInt(sub.full) || 100
                    );
                } else {
                    addSubjectRow(`Subject ${i + 1}`, '', '', '', 100);
                }
            }

            resultsPanel.classList.add('hidden');
            viewResultsBtn.style.display = 'none';
            resultsTableBody.innerHTML = ''; 
            overallGPADisplay.textContent = '--';
            overallPercentageDisplay.textContent = '--';
            totalMarksDisplay.textContent = '0 / 0';
            updateCircularMeter(0);
        }

        // --- 2. GPA Calculation Logic (Modified to use custom alert) ---

        function getGradeDetails(percentage, fullMarks, obtainedTheory, obtainedPractical) {
            let isFailed = false;

            if (fullMarks === 100) {
                if (obtainedTheory < PASS_MARKS.theory_75 || obtainedPractical < PASS_MARKS.practical_25) {
                    isFailed = true;
                }
            } else {
                if (obtainedTheory < PASS_MARKS[fullMarks]) {
                    isFailed = true;
                }
            }

            if (isFailed) {
                return GRADING_SCALE[GRADING_SCALE.length - 1]; 
            }
            
            const normalizedPercentage = parseFloat(percentage);
            return GRADING_SCALE.find(rule => normalizedPercentage >= rule.min && normalizedPercentage <= rule.max) || GRADING_SCALE[GRADING_SCALE.length - 1];
        }

        async function calculateGPA() {
            const subjectRows = document.querySelectorAll('.subject-row');
            
            let totalWeightedGPA = 0; 
            let totalFullMarks = 0;
            let totalObtainedMarks = 0;
            const subjectResultsData = []; 
            
            resultsTableBody.innerHTML = ''; 

            if (subjectRows.length === 0) {
                await showCustomAlert("Please add subjects before calculating.");
                return;
            }

            for (const row of subjectRows) {
                const name = row.querySelector('.subject-name').value || `Subject ${row.dataset.id}`;
                const full = parseFloat(row.querySelector('.full-marks').value);

                let obtained = 0;
                let obtainedTheory = 0;
                let obtainedPractical = 0;

                if (full === 100) {
                    obtainedTheory = parseFloat(row.querySelector('.marks-theory').value);
                    obtainedPractical = parseFloat(row.querySelector('.marks-practical').value);
                    obtained = obtainedTheory + obtainedPractical;
                } else {
                    obtained = parseFloat(row.querySelector('.marks-obtained').value);
                    obtainedTheory = obtained; 
                    obtainedPractical = 0;
                }

                if (isNaN(obtained) || isNaN(full) || full <= 0 || obtained > full) {
                    await showCustomAlert(`Invalid input for ${name}. Please check the marks.`);
                    resultsPanel.classList.add('hidden');
                    return; 
                }

                const percentage = (obtained / full) * 100;
                const details = getGradeDetails(percentage, full, obtainedTheory, obtainedPractical);
                
                totalWeightedGPA += details.gpa * full;
                totalFullMarks += full;
                totalObtainedMarks += obtained;
                
                subjectResultsData.push({
                    name: name,
                    percentage: percentage.toFixed(2),
                    grade: details.grade,
                    gpa: details.gpa.toFixed(2),
                    colorClass: details.colorClass
                });
            }
            
            const overallGPAFinal = totalFullMarks > 0 ? (totalWeightedGPA / totalFullMarks) : 0;
            const overallPercentage = totalFullMarks > 0 ? (totalObtainedMarks / totalFullMarks) * 100 : 0;
            
            displayResults(overallGPAFinal.toFixed(2), overallPercentage.toFixed(2), totalObtainedMarks, totalFullMarks, subjectResultsData);
            
            saveCalculatedResultsToLocalStorage(overallGPAFinal.toFixed(2), overallPercentage.toFixed(2), totalObtainedMarks, totalFullMarks, subjectResultsData);
            
            resultsPanel.classList.remove('hidden'); 
            
            if (window.innerWidth < 768) {
                viewResultsBtn.style.display = 'inline-block';
                toggleView('results');
            }
        }
        
        function displayResults(gpa, percentage, obtainedMarks, fullMarks, resultsData) {
            resultsTableBody.innerHTML = ''; 
            
            resultsData.forEach(data => {
                const resultHTML = `
                    <tr>
                        <td>${data.name}</td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-bar ${data.colorClass}-color" style="width:0;" data-percentage="${data.percentage}">
                                    ${data.percentage}%
                                </div>
                            </div>
                        </td>
                        <td class="grade-text-${data.colorClass.slice(-1)}">${data.grade}</td>
                        <td>${data.gpa}</td>
                    </tr>
                `;
                resultsTableBody.insertAdjacentHTML('beforeend', resultHTML);
            });
            
            animateProgressBars();
            
            overallGPADisplay.textContent = gpa;
            overallPercentageDisplay.textContent = `${percentage}%`;
            totalMarksDisplay.textContent = `${obtainedMarks} / ${fullMarks}`;
            updateCircularMeter(parseFloat(gpa));

            previousResultBanner.style.display = 'none'; 
        }

        // --- 3. UI/UX & Utility Functions (Modified to use custom alert/confirm) ---

        function animateProgressBars() {
            setTimeout(() => {
                document.querySelectorAll('.progress-bar').forEach(bar => {
                    requestAnimationFrame(() => {
                        bar.style.width = bar.dataset.percentage + '%';
                    });
                });
            }, 50); 
        }

        function updateCircularMeter(gpa) {
            const meter = document.querySelector('.overall-gpa-meter');
            const display = document.querySelector('.gpa-display span');
            
            let colorVar = 'var(--grade-D)';
            if (gpa >= 3.2) { colorVar = 'var(--grade-A)'; }
            else if (gpa >= 2.4) { colorVar = 'var(--grade-B)'; }
            else if (gpa >= 2.0) { colorVar = 'var(--grade-C)'; }
            
            meter.style.borderColor = colorVar;
            display.style.color = colorVar;
        }

        function saveSubjectsToLocalStorage() {
            const subjects = Array.from(document.querySelectorAll('.subject-row')).map(row => {
                const fullMarks = parseInt(row.querySelector('.full-marks').value);
                const data = {
                    name: row.querySelector('.subject-name').value,
                    full: fullMarks,
                    theory: '',
                    practical: '',
                    obtained: ''
                };
                if (fullMarks === 100) {
                    data.theory = row.querySelector('.marks-theory').value;
                    data.practical = row.querySelector('.marks-practical').value;
                    data.obtained = (parseFloat(data.theory) || 0) + (parseFloat(data.practical) || 0);
                } else {
                    data.obtained = row.querySelector('.marks-obtained').value;
                }
                return data;
            });
            localStorage.setItem('nebGpaSubjects', JSON.stringify(subjects));
            localStorage.setItem('nebGpaSubjectCount', subjects.length); 
            localStorage.setItem('nebGpaStream', subjectStreamDropdown.value);
        }
        
        function saveCalculatedResultsToLocalStorage(gpa, percentage, obtainedMarks, fullMarks, subjectResultsData) {
            const result = {
                gpa: gpa,
                percentage: percentage,
                obtained: obtainedMarks,
                full: fullMarks,
                date: new Date().toLocaleDateString('en-NP'), 
                subjects: subjectResultsData
            };
            localStorage.setItem('nebGpaLastResult', JSON.stringify(result));
            loadPreviousResult();
        }

        function loadSubjectsFromLocalStorage() {
            const savedCount = localStorage.getItem('nebGpaSubjectCount');
            const savedStream = localStorage.getItem('nebGpaStream');

            if (savedCount && parseInt(savedCount) >= 4 && parseInt(savedCount) <= 10) {
                subjectCountDropdown.value = savedCount;
            } else {
                subjectCountDropdown.value = 6; 
            }
            
            if(savedStream && SUBJECT_PRESETS[savedStream]) {
                subjectStreamDropdown.value = savedStream;
            } else {
                subjectStreamDropdown.value = 'custom';
            }

            generateInitialSubjects(true, false); 
            loadPreviousResult();
        }
        
        function loadPreviousResult() {
            const lastResultString = localStorage.getItem('nebGpaLastResult');
            if (lastResultString) {
                const lastResult = JSON.parse(lastResultString);
                
                lastGPADisplay.textContent = lastResult.gpa;
                lastCalcDateDisplay.textContent = lastResult.date;
                previousResultBanner.style.display = 'block';
                
            } else {
                 previousResultBanner.style.display = 'none';
            }
        }
        
        async function showLastResultHandler() {
            const lastResultString = localStorage.getItem('nebGpaLastResult');
            if (lastResultString) {
                const lastResult = JSON.parse(lastResultString);
                displayResults(lastResult.gpa, lastResult.percentage, lastResult.obtained, lastResult.full, lastResult.subjects);
                toggleView('results'); 
                resultsPanel.classList.remove('hidden'); 
            } else {
                await showCustomAlert("No previous results saved.");
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('nebGpaDarkMode', isDarkMode);
            
            const icon = document.getElementById('darkModeToggle').querySelector('i');
            icon.classList.toggle('fa-moon', !isDarkMode);
            icon.classList.toggle('fa-sun', isDarkMode);
        }

        async function resetAll() {
            const shouldReset = await showCustomConfirm("Are you sure you want to reset all data and inputs? This will clear local storage.");

            if (!shouldReset) {
                return;
            }
            localStorage.clear(); 
            subjectCountDropdown.value = 6; 
            subjectStreamDropdown.value = 'custom';
            subjectCounter = 0;
            
            resultsTableBody.innerHTML = ''; 
            overallGPADisplay.textContent = '--';
            overallPercentageDisplay.textContent = '--';
            totalMarksDisplay.textContent = '0 / 0';
            previousResultBanner.style.display = 'none'; 
            
            toggleView('input'); 
            generateInitialSubjects(); 
        }

        // Modal Logic
        function openAboutModal() {
            aboutModal.style.display = "block";
        }

        function closeAboutModal() {
            aboutModal.style.display = "none";
        }
        
        // --- 4. Export & Share Functions (Modified to use custom alert) ---
        async function shareResults() {
            if (resultsPanel.classList.contains('hidden')) {
                await showCustomAlert("Please calculate the GPA before sharing results.");
                return;
            }

            const gpa = overallGPADisplay.textContent;
            const percentage = overallPercentageDisplay.textContent;
            
            const shareText = `🎉 My NEB Results!\nOverall GPA: ${gpa}\nPercentage: ${percentage}\n\nCalculate your own GPA using the KingamerNep NEB Calculator!`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'NEB GPA Results',
                        text: shareText,
                    });
                } catch (error) {
                    fallbackCopyToClipboard(shareText);
                }
            } else {
                fallbackCopyToClipboard(shareText);
            }
        }

        async function fallbackCopyToClipboard(text) {
            navigator.clipboard.writeText(text).then(async () => {
                await showCustomAlert("Results copied to clipboard! Paste it wherever you like.");
            }).catch(async err => {
                await showCustomAlert("Failed to copy results. Please manually copy the results from the screen.");
            });
        }

        async function exportCsv() {
            if (resultsPanel.classList.contains('hidden')) {
                 await showCustomAlert("Please calculate the GPA before exporting results.");
                 return;
            }
            // ... (rest of exportCsv logic remains the same) ...
            const data = [["Subject", "Percentage", "Grade", "GPA"]];
            
            document.getElementById('perSubjectResults').querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                const progressBar = cells[1].querySelector('.progress-bar');
                const percentage = progressBar ? progressBar.textContent.trim() : 'N/A'; 

                data.push([
                    cells[0].textContent.trim(), 
                    percentage,
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim()
                ]);
            });

            data.push(["", "", "", ""]);
            data.push(["Overall GPA", overallGPADisplay.textContent, "", ""]);
            data.push(["Overall Percentage", overallPercentageDisplay.textContent, "", ""]);

            const csvContent = data.map(e => e.join(",")).join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "NEB_GPA_Results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function exportPdf() {
            if (resultsPanel.classList.contains('hidden')) {
                 await showCustomAlert("Please calculate the GPA before exporting results.");
                 return;
            }
            if (!window.jspdf || !window.jspdf.jsPDF.prototype.autoTable) {
                 await showCustomAlert("PDF export libraries are missing. Cannot export.");
                 return;
            }
            
            // ... (rest of exportPdf logic remains the same) ...
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("NEB GPA Calculator Results", 14, 22);

            const totalText = document.getElementById('totalMarks').textContent.trim();
            doc.setFontSize(11);
            doc.text(`Overall GPA: ${overallGPADisplay.textContent}`, 14, 35);
            doc.text(`Overall Percentage: ${overallPercentageDisplay.textContent}`, 14, 41);
            doc.text(`Total Marks: ${totalText}`, 14, 47);

            const tableHeaders = [["Subject", "Percentage", "Grade", "GPA"]];
            const tableData = [];

            document.getElementById('perSubjectResults').querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                const progressBar = cells[1].querySelector('.progress-bar');
                const percentage = progressBar ? progressBar.textContent.trim() : 'N/A'; 
                
                tableData.push([
                    cells[0].textContent.trim(),
                    percentage,
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim()
                ]);
            });
            
            doc.autoTable({
                startY: 55,
                head: tableHeaders,
                body: tableData,
                theme: 'striped',
                styles: { fontSize: 10, cellPadding: 3 },
                headStyles: { fillColor: [0, 123, 255] }
            });

            doc.setFontSize(8);
            doc.text("© 2025 KingamerNep David | Made with ❤️ by KingamerNep", 14, doc.internal.pageSize.height - 10);

            doc.save("NEB_GPA_Results.pdf");
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Dark Mode Init
            const isDarkMode = localStorage.getItem('nebGpaDarkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').querySelector('i').classList.remove('fa-moon');
                document.getElementById('darkModeToggle').querySelector('i').classList.add('fa-sun');
            }

            loadSubjectsFromLocalStorage();
            
            // Event Bindings
            document.getElementById('addSubjectBtn').addEventListener('click', () => addSubjectRow());
            document.getElementById('calculateBtn').addEventListener('click', calculateGPA);
            
            // Navigation Bindings
            document.getElementById('backToInputBtn').addEventListener('click', () => toggleView('input'));
            document.getElementById('viewResultsBtn').addEventListener('click', () => toggleView('results'));
            document.getElementById('showLastResultBtn').addEventListener('click', showLastResultHandler); 

            // General Bindings
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
            document.getElementById('exportPdfBtn').addEventListener('click', exportPdf);
            document.getElementById('shareBtn').addEventListener('click', shareResults); 

            // Modal Bindings
            aboutAppBtn.addEventListener('click', openAboutModal);
            closeBtn.addEventListener('click', closeAboutModal);
            window.addEventListener('click', (event) => {
                if (event.target == aboutModal) {
                    closeAboutModal();
                }
                if (event.target == customDialogModal) {
                    // Prevent closing dialog by clicking outside if it's an alert
                    // (It should only close via button for confirmation)
                    if (dialogActions.children.length === 1) { 
                        customDialogModal.style.display = 'none';
                    }
                }
            });

            subjectCountDropdown.addEventListener('change', async () => {
                subjectStreamDropdown.value = 'custom'; 
                await generateInitialSubjects(false);
            });
            
            subjectStreamDropdown.addEventListener('change', handleStreamChange); 
            
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    body.classList.remove('input-view', 'results-view');
                } else {
                    if (body.classList.contains('results-view')) {
                         resultsPanel.classList.remove('hidden');
                    } else {
                         body.classList.add('input-view');
                    }
                }
            });
        });

    </script>
</body>
</html>
